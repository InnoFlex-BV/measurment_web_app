services:
  # PostgreSQL database service - the persistent data store for all experiment data
  postgres:
    # Using PostgreSQL 15 - a specific version rather than 'latest' ensures reproducibility
    image: postgres:15
    
    # Container name makes it easy to identify when using docker ps
    container_name: lab_postgres
    
    # Environment variables configure the database at startup
    environment:
      # Superuser credentials - in production these would come from secrets management
      # TODO: move to secrets file
      POSTGRES_USER: labuser
      POSTGRES_PASSWORD: labpassword
      # Initial database name - PostgreSQL will create this on first startup
      POSTGRES_DB: labdata
    
    # Volumes provide persistent storage and initialization scripts
    volumes:
      # Named volume stores actual database files, persists across container restarts
      - postgres_data:/var/lib/postgresql/data
      # Mount initialization scripts from our project into the container
      # Any .sql files here run automatically on first database startup
      - ./database/init:/docker-entrypoint-initdb.d/
    
    # Port mapping exposes PostgreSQL to the host for development access
    # Format is "host_port:container_port"
    ports:
      - "5432:5432"
    
    # Health check ensures the database is actually ready to accept connections
    # Other services can wait for this before starting
    healthcheck:
      # pg_isready is a PostgreSQL utility specifically for checking readiness
      # TODO: use values from secrets file
      test: ["CMD-SHELL", "pg_isready -U labuser -d labdata"]
      # Check every 5 seconds
      interval: 5s
      # Wait 5 seconds for the check to complete
      timeout: 5s
      # Try 5 times before marking as unhealthy
      retries: 5
    
    # Networks this service connects to (will be defined below)
    networks:
      - lab_network

  # Backend API service - FastAPI application handling business logic
  backend:
    # Build from local Dockerfile rather than using pre-made image
    build:
      # Context is the directory containing files needed for the build
      context: ./backend
      # Dockerfile name (could be omitted if using default 'Dockerfile')
      dockerfile: Dockerfile
    
    container_name: lab_backend
    
    # Wait for PostgreSQL to be healthy before starting
    depends_on:
      postgres:
        condition: service_healthy
    
    # Environment variables for database connection and app configuration
    environment:
      # Database connection string - SQLAlchemy will use this
      # Format: postgresql://username:password@host:port/database
      # TODO: use values from secrets file
      DATABASE_URL: postgresql://labuser:labpassword@postgres:5432/labdata
      # Note: 'postgres' is the service name, which acts as hostname in Docker network
      
      # Python unbuffered mode ensures logs appear immediately
      PYTHONUNBUFFERED: 1
    
    volumes:
      # Mount source code for hot reloading during development
      # Changes to Python files trigger automatic server restart
      - ./backend:/app
    
    # Expose FastAPI server to host machine
    ports:
      - "8000:8000"
    
    # Override default command to run development server with auto-reload
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    
    networks:
      - lab_network

  # Frontend service - React application providing the user interface
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    
    container_name: lab_frontend
    
    # Frontend needs backend to be running for API calls
    depends_on:
      - backend
    
    environment:
      # Tell React where the backend API is located
      # In development, this goes through the host since browser makes the request
      REACT_APP_API_URL: http://localhost:8000
      
      # Disable React's browser opening behavior in container
      BROWSER: none
      
      # Enable fast refresh for better development experience
      FAST_REFRESH: true
    
    volumes:
      # Mount source code for hot module replacement
      - ./frontend:/app
      # Exclude node_modules from the mount to prevent version conflicts
      # This creates an anonymous volume that stays inside the container
      - /app/node_modules
    
    ports:
      - "3000:3000"
    
    # Start React development server
    command: npm start
    
    networks:
      - lab_network

# Named volumes persist data outside container lifecycle
volumes:
  postgres_data:
    # This volume stores all PostgreSQL data files
    # Data survives container removal and system restarts

# Networks allow services to communicate with each other
networks:
  lab_network:
    # Bridge network is the default type - provides DNS and isolation
    driver: bridge
